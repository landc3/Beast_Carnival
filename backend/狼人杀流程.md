# 狼人杀游戏流程

## 夜晚阶段流程

### 1. 夜晚开始
- AI主持人宣布："第X夜开始，所有玩家请闭眼。"

**信息隔离原则**：
   - 女巫睁眼时，主持人必须告知她「今晚被狼人击杀的玩家编号」（若无人被刀则告知“平安”）。
   - 守卫睁眼时，**不得被告知被刀者**，只能自主选择一名玩家进行守护（不能连续两晚守护同一人）。

### 2. 守卫阶段（30s）
- AI主持人宣布："守卫请睁眼，选择你要守护的玩家。"
- 守卫收到私密消息，选择守护目标
- 规则：不能连续两晚守护同一人

### 3. 狼人阶段(30s)
- AI主持人宣布："守卫请闭眼。狼人请睁眼，共同选择要击杀的玩家。"
- 所有狼人收到私密消息，选择击杀目标
- 需要所有狼人都投票，以多数决定最终目标
- **狼人聊天功能**：
  - 在狼人行动弹窗左侧显示狼人专用聊天对话框
  - 只有狼人玩家可以在此聊天中交流，讨论击杀目标
  - 聊天消息仅对狼人玩家可见
- **AI狼人自动投票**：
  - AI狼人玩家会自动跟随人类狼人的投票
  - 如果人类狼人已投票，AI狼人会跟随多数投票
  - 如果还没有投票，AI狼人会随机选择目标

### 4. 预言家阶段(30s)
- AI主持人宣布："狼人请闭眼。预言家请睁眼，选择你要查验的玩家。"
- 预言家收到私密消息，选择查验目标
- 主持人私聊返回"好人"或"狼人"

### 5. 女巫阶段(30s)
- AI主持人宣布："预言家请闭眼。女巫请睁眼。"
- 女巫收到私密消息，被告知昨夜被刀者（若有）
- 女巫可以选择：
  - 使用解药（救被刀者）
  - 使用毒药（毒杀一人）
  - 不使用任何药水
- 规则：
  - 每瓶药只能用一次
  - 每晚只能使用一种药水
  - 首夜不能自救

### 6. 夜晚结束
- AI主持人宣布："女巫请闭眼。所有玩家请闭眼。"


### 7. 夜晚结算
按照以下规则结算夜晚结果：

#### 被刀者处理：
- 若被刀者被守卫守护且未被女巫救 → 存活
- 若被刀者被女巫救且未被守卫守 → 存活
- 若被刀者同时被守+救 → 死亡（"同守同救"规则）
- 若被刀者未被守且未被救 → 死亡

#### 被毒者处理：
- 若女巫毒人 → 被毒者死亡（无论是否被守，毒药无视守卫）

#### 猎人处理：
 **触发条件**：
   - 猎人必须是因以下原因死亡才可开枪：
     a. 被狼人击杀（且未被女巫毒药杀死）
     b. 被白天投票处决
   - 若猎人是被女巫毒死（无论是否同时被刀），则**禁止开枪**

2. **开枪时机**：
   - 在白天阶段开始时，主持人公布所有夜间死亡玩家后，**立即检查猎人是否死亡且可开枪**
   - 如果满足条件，提示：“【猎人】你已死亡，是否要开枪带走一名玩家？(输入编号)”
   - 玩家选择一名**存活玩家**作为目标，该目标立即死亡（不触发其他技能）

3. **实现细节**：
   - 在 Player 类中添加属性：`role` 和 `died_by`（记录死亡原因，如 'wolf', 'vote', 'poison'）
   - 在 GameMaster 的 `day_phase()` 方法中：
     a. 先公布夜间死亡名单
     b. 检查是否有猎人死亡且 `died_by != 'poison'`
     c. 若有，调用 `_hunter_action(hunter_player)` 方法处理开枪
   - 开枪目标必须是当前存活玩家，且不能是猎人自己（已死亡）

4. **输出示例**：
   - “昨晚死亡：5号（猎人，被狼人击杀）。”
   - “【猎人技能】5号请选择你要带走的玩家编号：3”
   - “3号被猎人带走，身份是……”

5. **边界处理**：
   - 若猎人被刀 + 被毒 → died_by = 'poison' → 不能开枪
   - 若猎人被投票出局 → died_by = 'vote' → 可开枪
   - 开枪后需更新玩家状态并重新检查胜利条件
- 若猎人死亡且非中毒，触发开枪（在白天公布死讯后立即开枪）

## 白天阶段流程

### 1. 公布夜晚结果
- AI主持人宣布死亡信息
- 如果有猎人死亡且可以开枪，立即触发猎人开枪流程

### 2. 讨论阶段
- 玩家可以发言讨论
- 时间限制：180秒（3分钟）

### 3. 投票阶段
- 
1. **投票资格**：
   - 所有当前存活的玩家均可投票，每人一票。
   - 玩家通过 input() 输入目标玩家编号（必须是存活玩家）。

2. **投票执行流程**：
   - 主持人提示：“请所有存活玩家依次投票（输入你要处决的玩家编号）：”
   - 按玩家顺序收集投票（可用循环遍历 alive_players）。
   - 统计票数，找出得票最高的玩家。

3. **平票处理**：
   - 若最高票数出现多人平票（如 3号 和 5号 各得3票），则**无人被处决**。
   - 打印：“投票平票，无人出局。”
   - 跳过死亡和遗言环节，直接进入夜晚。

4. **处决与死亡**：
   - 若有唯一最高票者，则该玩家被处决，标记为死亡。
   - 记录其死亡原因为 'vote'（用于猎人技能判断）。

5. **遗言机制**：
   - **所有白天死亡的玩家（包括被投票处决、被猎人带走等）都可以说遗言**。
   - 在玩家死亡后，主持人提示：“【遗言】X号，请发表你的遗言：”
   - 使用 input() 模拟遗言输入（可留空），并打印出来供所有人“看到”。

6. **特殊角色联动**：
   - 如果被处决者是猎人，且未被毒死，则：
     a. 先执行遗言（或遗言中声明开枪）
     b. 然后触发猎人技能：选择一名玩家开枪带走（参考已有 _hunter_action 方法）
   - 开枪导致的死亡也应允许遗言（即“链式遗言”）。

7. **输出示例**：
   - “投票结果：3号得4票，被处决。”
   - “【遗言】3号：我是预言家，昨晚查5号是狼！”
   - （若3号是猎人）“【猎人技能】3号请选择你要带走的玩家：5”
- 时间限制：30秒


### 5. 进入下一夜
- 如果游戏未结束，进入下一夜

## 游戏结束条件

### 好人胜利：
- 所有狼人死亡

### 狼人胜利：
- 所有神职死亡（屠神）
- 或所有平民死亡（屠民）
