# 多人游戏访问说明

## 📍 访问地址

### 对于服务器本机（创建房间的人）
- **前端地址**: `http://localhost:4399/werewolf`
- **后端地址**: `http://localhost:1998`

### 对于其他玩家（局域网内）
1. **获取服务器IP地址**：
   - 在服务器上运行 `ipconfig`（Windows）或 `ifconfig`（Linux/Mac）
   - 找到你的局域网IP地址（通常是 `192.168.x.x` 或 `10.x.x.x`）
   - 例如：`192.168.1.14` 或 `192.168.6.10`

2. **访问地址**：
   - **前端地址**: `http://[服务器IP]:4399/werewolf`
   - 例如：`http://192.168.1.14:4399/werewolf`

### 配置后端地址（如果需要）

如果前端和后端不在同一台机器上，需要设置环境变量：

1. 在 `frontend` 目录下创建 `.env` 文件：
```bash
VITE_API_HOST=192.168.1.14  # 替换为实际的后端服务器IP
VITE_API_PORT=1998
```

2. 重启前端服务器

## 🎮 多人加入房间流程

### 1. 创建房间（房主）
1. 打开游戏页面：`http://localhost:4399/werewolf`（或服务器IP）
2. 输入你的名字
3. 点击"创建房间"按钮
4. 系统会生成一个房间号（例如：`a1b2c3d4`）
5. 将房间号分享给其他玩家

### 2. 加入房间（其他玩家）
1. 打开游戏页面：`http://[服务器IP]:4399/werewolf`
2. 输入你的名字
3. 在"或输入房间号加入"输入框中输入房间号
4. 点击"加入房间"按钮
5. 成功加入后，会看到房间内的所有玩家

### 3. 开始游戏
- 房间需要至少 **4人** 才能开始游戏
- 最多支持 **12人** 同时游戏
- 房主可以点击"🤖 添加人机"来添加AI玩家
- 房主可以点击"⚡ 自动填充到12人"来快速添加AI玩家
- 当人数达到要求后，房主点击"开始游戏"按钮

## 🔍 多人加入房间逻辑检查

### 后端逻辑（`backend/services/werewolf_service.py`）

#### 创建房间 (`create_room`)
- ✅ 生成唯一房间ID（8位UUID）
- ✅ 创建房间对象，初始化所有字段
- ✅ 保存到Redis数据库
- ✅ 返回房间ID

#### 加入房间 (`join_room`)
- ✅ 检查房间是否存在
- ✅ 检查玩家是否已加入（避免重复加入）
- ✅ 检查房间是否已满（最多12人）
- ✅ 创建玩家对象并添加到房间
- ✅ 保存更新后的房间数据到Redis
- ✅ 记录日志

#### WebSocket连接 (`/ws/werewolf/{room_id}/{user_id}`)
- ✅ 建立WebSocket连接
- ✅ 发送房间状态给新连接的玩家
- ✅ 发送私有消息（身份信息等）
- ✅ 发送公共消息历史
- ✅ 处理玩家行动、发言、投票等

### 前端逻辑（`frontend/src/views/Werewolf.vue`）

#### 创建房间 (`createRoom`)
- ✅ 验证用户名
- ✅ 调用API创建房间
- ✅ 自动加入创建的房间
- ✅ 连接WebSocket

#### 加入房间 (`joinRoom`)
- ✅ 验证用户名和房间号
- ✅ 调用API加入房间
- ✅ 连接WebSocket
- ✅ 开始轮询房间状态

#### WebSocket连接 (`connectWebSocket`)
- ✅ 使用房间ID和用户ID建立连接
- ✅ 处理房间状态更新
- ✅ 处理公共消息
- ✅ 处理私有消息
- ✅ 处理房间更新

## ⚠️ 注意事项

1. **防火墙设置**：
   - 确保服务器的防火墙允许端口 `4399`（前端）和 `1998`（后端）的入站连接
   - Windows: 在"Windows Defender 防火墙"中添加端口规则
   - Linux: 使用 `ufw` 或 `iptables` 开放端口

2. **网络要求**：
   - 所有玩家必须在同一局域网内（或通过VPN连接）
   - 如果要在互联网上访问，需要配置端口转发或使用内网穿透工具（如 ngrok、frp 等）

3. **Redis服务**：
   - 确保Redis服务正在运行
   - 所有玩家共享同一个Redis实例（房间数据存储在Redis中）

4. **房间号分享**：
   - 房间号是8位随机字符串
   - 房主创建房间后，需要将房间号告诉其他玩家
   - 其他玩家输入房间号即可加入

## 🐛 常见问题

### Q: 其他玩家无法访问游戏
**A**: 检查以下几点：
1. 服务器防火墙是否开放了端口 4399 和 1998
2. 前端服务器是否配置为 `0.0.0.0`（已配置）
3. 其他玩家使用的IP地址是否正确
4. 是否在同一局域网内

### Q: 加入房间失败
**A**: 可能的原因：
1. 房间号输入错误
2. 房间已满（最多12人）
3. 房间不存在或已过期
4. 网络连接问题

### Q: WebSocket连接失败
**A**: 检查：
1. 后端服务是否正常运行
2. 前端代理配置是否正确
3. 如果使用环境变量，是否正确设置了 `VITE_API_HOST`

## 📝 技术细节

- **前端端口**: 4399
- **后端端口**: 1998
- **WebSocket路径**: `/ws/werewolf/{room_id}/{user_id}`
- **API路径**: `/api/werewolf/room/{room_id}/join`
- **最大玩家数**: 12人
- **最小开始人数**: 4人
- **数据存储**: Redis

